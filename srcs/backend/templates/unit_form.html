{% extends "base.html" %}

{% block title %}Create New Unit - PartStock{% endblock %}

{% block content %}
<div class="form-container">
    <h2>Create New Unit</h2>
    
    <div id="error-message" class="error-message" style="display: none;"></div>
    
    <form class="unit-form" id="unitForm">
        <div class="form-group">
            <label for="product_id">Select Product *</label>
            <select name="product_id" id="product_id" required>
                <option value="">Choose a product...</option>
                {% for product in products %}
                <option value="{{ product.id }}" 
                    {% if selected_product and selected_product.id == product.id %}selected{% endif %}>
                    {{ product.sku }} - {{ product.title }}
                </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="selling_price">Selling Price (â‚¬) *</label>
            <input 
                type="number" 
                name="selling_price" 
                id="selling_price" 
                step="0.01" 
                min="0" 
                placeholder="0.00"
                required
            >
        </div>
        
        <div class="form-group">
            <label for="alternative_sku">Alternative SKU</label>
            <input 
                type="text" 
                name="alternative_sku" 
                id="alternative_sku" 
                placeholder="Custom reference (optional)"
                maxlength="100"
            >
        </div>
        
        <div class="form-group">
            <label for="km">Kilometers (Motor parts only)</label>
            <input 
                type="number" 
                name="km" 
                id="km" 
                min="0" 
                placeholder="Motor kilometers"
            >
        </div>
        
        <div class="form-group">
            <label for="observations">Observations</label>
            <textarea 
                name="observations" 
                id="observations" 
                placeholder="Notes about condition, defects, etc. (max 150 characters)"
                maxlength="150"
                rows="3"
            ></textarea>
            <small>Characters remaining: <span id="obs-char-count">150</span></small>
        </div>
        
        <div class="form-group">
            <label for="status">Status *</label>
            <select name="status" id="status" required>
                <option value="active">Active (Available for sale)</option>
                <option value="incomplete">Incomplete (Missing parts/info)</option>
                <option value="consume">Consume (Used in our cars)</option>
                <option value="sold">Sold</option>
            </select>
        </div>
        
        <div class="form-actions">
            <button type="button" onclick="history.back()" class="btn btn-secondary">Cancel</button>
            <button type="submit" class="btn btn-primary">Create Unit</button>
        </div>
    </form>
</div>

<script>
    // Character counter for observations
    document.getElementById('observations').addEventListener('input', function() {
        const remaining = 150 - this.value.length;
        document.getElementById('obs-char-count').textContent = remaining;
        
        if (remaining < 10) {
            document.getElementById('obs-char-count').style.color = 'red';
        } else {
            document.getElementById('obs-char-count').style.color = 'inherit';
        }
    });

    // Form submission
    document.getElementById('unitForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Collect and validate form data
        const formData = {
            product_id: parseInt(document.getElementById('product_id').value),
            selling_price: Math.round(parseFloat(document.getElementById('selling_price').value) * 100),
            alternative_sku: document.getElementById('alternative_sku').value || null,
            km: document.getElementById('km').value ? parseInt(document.getElementById('km').value) : null,
            observations: document.getElementById('observations').value || null,
            status: document.getElementById('status').value
        };
        
        // Validation
        if (!formData.product_id) {
            showError('Please select a product.');
            return;
        }
        
        if (!formData.selling_price || formData.selling_price <= 0) {
            showError('Please enter a valid selling price.');
            return;
        }
        
        try {
            const response = await fetch('/api/v1/units', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });
            
            if (response.ok) {
                const result = await response.json();
                // Redirect to unit detail page
                window.location.href = `/units/${result.id}`;
            } else {
                const error = await response.json();
                showError(error.detail || 'Failed to create unit');
            }
        } catch (error) {
            showError('Network error: ' + error.message);
        }
    });

    // Show error message function
    function showError(message) {
        let errorDiv = document.getElementById('error-message');
        if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.id = 'error-message';
            errorDiv.className = 'error-message';
            document.querySelector('.form-container').insertBefore(errorDiv, document.querySelector('form'));
        }
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        errorDiv.scrollIntoView({behavior: 'smooth'});
    }
</script>
{% endblock %}
